---
title: "serofoi"
output: rmarkdown::html_vignette
bibliography: references.bib
link-citations: true
vignette: >
  %\VignetteIndexEntry{serofoi}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r cleaning, include = FALSE, echo = TRUE, message=FALSE}
library(serofoi)
rownames(mydata) <- NULL 
data_test <- prepare_data(mydata)


```

# Use cases

## For the models defined in the *serofoi* package

**serofoi** is an R package that allows estimations of the Force-of-Infection from a population based serosurvey data.

## **Sero-survey data**

Surveys had to meet all of the following inclusion criteria:

1.  Be population-based (not hospital based)

2.  Specify individuals' age or age group

3.  Indicate diagnostic test(s) used. The current version of serofoi only applies to *IgG* antibodies)

4.  Identify the location and date (year) of sample collection

## Model assumptions

Current version of **serofoi** includes the following assumptions on the underlying biological process:

-   The Force-of-infection (FoI) is estimated using a catalytic model

-   There is no sero-reversion (from positive to negative). It means IgG antibodies are life-long duration with no waning immunity. This may not be the case for several pathogens. This feature is planned for future versions of *serofoi***.**

-   There is no age-dependency. This may not be the case for several pathogens. This feature is planned for future versions of *serofoi***.**

-   There is no impact from migration processes in the sampled population

-   There are no differences in the mortality rate of infected versus susceptible individuals

::: {.alert .alert-primary}
NOTE: Running the *serofoi* models for the first time on your local computer make take a few minutes while the *rstan* code is compiled locally. Afterwards, no further local compilation is needed.
:::

# **Constant vs Time-varying** FoI models

## Constant Force-of-Infection (endemic model)

For *constant* *endemic model*, the rate of infection acquisition―rate of seroconversion―is constant over time, and infection (sero)prevalence will increase monotonically with age as cumulative exposure increases.

Denoting $n(a,t)$ the number of seropositive individuals of age $a$ at time $t$ , $N$ the serosurvey sample size, and $P(a,t)$ the underlying seroprevalence at age $a$ at time $t$, we assumed that the number of seropositive subjects follows a Binomial distribution $n(a,t)$ \~ $B(N,P(a,t))$.

For the force-of-infection (FoI) that is constant over time, denoted $\lambda$, we modelled seroprevalence for age $a$ in year $t$ (i.e. the time when the serosurvey occurred) as:

$$ P(a,t) = 1−exp(−\lambda{a})$$

The corresponding code for the constant-FoI model with binomial distribution is:

```{r model_1, include = FALSE, echo=TRUE, errors = FALSE, warning = FALSE, message = FALSE }
model_1 <- run_model(model_data = data_test,
                     model_name = "constant_foi_bi",
                     n_iters = 500, 
                     n_thin = 2)

```

## Time-varying Force-of-Infection

For the time-varying FoI model, the FoI values are estimated from a binomial distribution. The sero-prevalence as age a can be expressed as:

$$
𝑃(𝑎,𝑡)=1−exp(−∑_{i=t-a+1}^{t}𝜆{i})
$$

Therefore, a serosurvey completed at time $t$ and including ages $a$ from {$age_{min}, age_{max}$} is informative on exposure (and FoI) between {$t, age_{max}$} and $t$.

Currently, two models within *serofoi* allow time-varying FoI, with corresponding code:

```{r model_2, include = FALSE, echo = TRUE, errors = FALSE, warning = FALSE, message = FALSE }
model_2 <- run_model(model_data = data_test,
                     model_name = "continuous_foi_normal_bi",
                     n_iters = 1500, 
                     n_thin = 2)

model_3 <- run_model(model_data = data_test,
                     model_name = "continuous_foi_normal_log",
                     n_iters = 1500, 
                     n_thin = 2)
```

## Fitting process

Models are implemented in **RStan** using the No-U-Turn sampler, a type of Hamiltonian Monte Carlo sampling. After convergence, the best-fitting models can be selected based on the expected log predictive density for an out-of-sample data point (elpd).

## Case use #1. Chagas disease (endemic disease)

Based on the data and analysis shown in [@Cucunubá2017], we use one of the datasets for measuring the sero-prevalence of IgG antibodies against *Trypanosoma cruzi* infection in Colombia in 2007. The dataset is part of the serofoi package as `chagas2007`.

```{r data_chagas, include = TRUE, errors = FALSE, warning = FALSE, message = FALSE }
chagas2007 <- mydata # Esto se debe eliminar cuando ya esté chagas2007
head(chagas2007, 5)

```



After preparring the data we can run the three different models available on serofoi, one constant and two time-varying model.


```{r three models, include = TRUE, errors = FALSE, warning = FALSE, message = FALSE }

chagas2007p <- prepare_data(chagas2007)

model_1 <- run_model(model_data = chagas2007p,
                     model_name = "continuous_foi_normal_bi",
                     n_iters = 500, 
                     n_thin = 2)

model_2 <- run_model(model_data = chagas2007p,
                     model_name = "continuous_foi_normal_log",
                     n_iters = 500, 
                     n_thin = 2)

model_3 <- run_model(model_data = chagas2007p,
                     model_name = "continuous_foi_normal_log",
                     n_iters = 500, 
                     n_thin = 2)



p1 <- plot_model(model_1, size_text = 15)
p2 <- plot_model(model_2, size_text = 15)
p3 <- plot_model(model_3, size_text = 15)

plot_seroprev_models_grid(p1, p2, p3, n_row = 1, n_col = 3)

```

## Case use 2. Alphaviruses (epidemic disease)

Based on the data and analysis shown in [@Carrera2020], we use a dataset for measuring the sero-prevalence of *Alphaviruses,* more especifically in Panamá.

## References
